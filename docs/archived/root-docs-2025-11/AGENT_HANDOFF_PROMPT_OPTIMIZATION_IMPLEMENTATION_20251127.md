# Agent Handoff: Prompt Optimization Implementation
**Date**: 2025-11-27  
**Status**: Ready for Implementation  
**Estimated Duration**: 2-3 weeks  
**Priority**: High

---

## Mission
Implement 13 prompt optimization improvements across 6 phases that will reduce regeneration rates by 20-30%, improve anatomical accuracy by 15-25%, and enhance style consistency across generated content.

---

## Baseline Metrics Reference

> **Before making changes**, run baseline capture to generate metrics for current state.

| Resource | Type | Purpose |
|----------|------|---------|--------|
| `scripts/baseline_metrics_capture.ipynb` | Source | Jupyter notebook to capture/analyze baseline metrics |
| `scripts/run-baseline-capture.ps1` | Source | PowerShell script to execute notebook and validate outputs |
| `scripts/baseline_metrics.json` | **Output** | Pre-optimization prompt metrics (**generated by notebook**) |
| `scripts/documentation_drift_report.json` | **Output** | Plan-to-repo discrepancies (**generated by notebook**) |

**To generate baseline artifacts:**
```powershell
# Option 1: Run script directly
./scripts/run-baseline-capture.ps1

# Option 2: Run notebook manually in VS Code (Shift+Enter each cell)
```

### Current Feature Flag Defaults (Verified 2025-11-27)
```typescript
// From utils/featureFlags.ts - DEFAULT_FEATURE_FLAGS
subjectFirstPrompts: false,      // ‚Üê Enable in Phase 1
promptQualityGate: false,        // ‚Üê Enable in Phase 1
promptTokenGuard: 'warn',        // ‚Üê Already 'warn' (NOT 'off')
keyframePromptPipeline: true,    // ‚Üê Already enabled
enhancedNegativePrompts: false,  // ‚Üê Enable after expanding categories
bibleV2SaveSync: true,           // ‚Üê Already enabled
sceneListValidationMode: 'warn', // ‚Üê Already 'warn'
```

---

## Context & Documentation

### Essential Reading (30 minutes)
1. **Start here**: `Documentation/PROMPT_OPTIMIZATION_IMPLEMENTATION_GUIDE.md` - Complete specification with tasks, acceptance criteria, and code examples
2. **Background**: `Documentation/PROMPT_OPTIMIZATION_IMPROVEMENT_PLAN.md` - Research foundation and phase overview
3. **Project context**: `README.md` - Overall project status
4. **Architecture**: `Documentation/Architecture/WORKFLOW_ARCHITECTURE_REFERENCE.md` - ComfyUI integration

### Key Discovery
**~40% of infrastructure already exists in the codebase**, significantly reducing implementation effort:

| Component | Location | Status | Notes |
|-----------|----------|--------|-------|
| `subjectFirstPrompts` flag | `utils/featureFlags.ts` (search: `DEFAULT_FEATURE_FLAGS`) | ‚úÖ Exists | Default: `false` |
| `keyframePromptPipeline` flag | `utils/featureFlags.ts` | ‚úÖ Exists | Default: `true` (already enabled) |
| `promptQualityGate` flag | `utils/featureFlags.ts` | ‚úÖ Exists | Default: `false` |
| `promptTokenGuard` flag | `utils/featureFlags.ts` | ‚úÖ Exists | Default: `'warn'` (NOT 'off') |
| `buildSceneKeyframePromptV2` | `services/promptPipeline.ts` (search: `buildSceneKeyframePromptV2`) | ‚úÖ Complete | Routes from V1 when flag enabled |
| `ENHANCED_NEGATIVE_SET` | `services/promptConstants.ts` | ‚úÖ Complete (8/8 defined, 7 merged) | `style_contamination` excluded by default |
| `applyWeight()` function | `services/promptWeighting.ts` | ‚úÖ Complete | Clamping [0.1, 2.0] |
| `estimateCLIPChunks()` | `services/tokenValidator.ts` | ‚úÖ Complete | Uses 77-token CLIP chunks |
| `usePromptMetrics` hook | `utils/usePromptMetrics.ts` | ‚úÖ Complete | IndexedDB persistence |
| A/B testing infrastructure | `services/generationMetrics.ts` | ‚úÖ Complete | Needs Bayesian extension |

> **‚ö†Ô∏è IMPORTANT**: Use symbol search (Ctrl+Shift+O) to find components. Line numbers drift with edits.

---

## Revised Implementation Plan

### Phase 1: Foundation (2 days) - QUICKEST WINS
**Effort**: 2-3 hours total (mostly configuration changes)

#### Task 1.1: Enable Subject-First Ordering (30 min)
- **File**: `utils/featureFlags.ts` (search: `subjectFirstPrompts` in `DEFAULT_FEATURE_FLAGS`)
- **Change**: `subjectFirstPrompts: false` ‚Üí `subjectFirstPrompts: true`
- **Why**: `buildSceneKeyframePromptV2` already routes here when flag is true
- **Testing**: Run existing `promptPipeline.test.ts` (already has tests)

#### Task 1.2: Expand Negative Prompt Categories (2-3 hours)
- **File**: `services/promptConstants.ts` (modify existing `ENHANCED_NEGATIVE_SET`)
- **Add 5 new categories** to existing structure:
  - `text_artifacts` (10 terms) - text, watermark, logo, signature, username, copyright, caption, subtitle, credits, stock photo
  - `depth` (6 terms) - flat composition, no depth, incorrect perspective, distorted perspective, fisheye distortion, lens distortion, flat lighting
  - `motion` (7 terms) - static pose, frozen movement, motion blur artifacts, ghosting, stuttering, temporal inconsistency, flickering
  - `style_contamination` (9 terms) - cartoon, anime, illustration, sketch, drawing, painting, abstract, surreal, CGI
  - `quality_tiers` (8 terms) - worst quality, low quality, normal quality, jpeg artifacts, compression artifacts, pixelated, noise, banding
- **Update PROVIDER_CONFIGS**: Merge new categories into `comfyui` enhanced presets
- **Testing**: 
  - Unit test: Verify no duplicate terms across categories
  - Unit test: Verify all categories appear in merged arrays
  - Integration test: Generate 5 images, verify no text/watermarks

#### Task 1.3: Enable Quality Gate (30 min)
- **File**: `utils/featureFlags.ts` (search: `promptQualityGate` in `DEFAULT_FEATURE_FLAGS`)
- **Change**: `promptQualityGate: false` ‚Üí `promptQualityGate: true`
- **Why**: Infrastructure complete, just enable the flag
- **Testing**: Verify quality scores logged during generation

---

### Phase 2: CLIP Token Optimization (3-4 days)
**Effort**: Moderate - mostly integration, some new code

#### Task 2.1: CLIP 77-Token Chunk Awareness (6-8 hours)
- **Files**: `services/promptPipeline.ts`, `services/tokenValidator.ts`
- **What exists**: `estimateCLIPChunks()` already calculates chunk positions
- **What's needed**: Integrate chunk-aware ordering into `buildSceneKeyframePromptV2`
- **Implementation**:
  ```typescript
  // In buildSceneKeyframePromptV2, organize segments by chunk priority:
  const chunk1Priority = [summarySegment];      // Subject first (0-77 tokens)
  const chunk2Priority = [...styledCharacters, styleSegment];  // Style
  const chunk3Priority = [technicalSegment];    // Technical
  const finalPriority = [qualityTokens];        // Quality
  
  const positiveSegments = [
    ...chunk1Priority,
    ...chunk2Priority,
    ...chunk3Priority,
    ...finalPriority,
  ].filter(Boolean);
  ```
- **Testing**: Verify subject stays in tokens 0-77 via `estimateTokens()`

#### Task 2.2: Director's Vision Keyword Extraction (4-6 hours)
- **New File**: `services/styleExtractor.ts`
- **What's needed**: Extract style keywords from director's vision text
- **Design**: Use JSON config with embedded defaults (like `localGenSettings.json`)
  - User can import custom keywords via Settings UI
  - Default keywords embedded as fallback
- **Implementation structure**:
  ```typescript
  // 6 style categories with keywords (lighting, camera, mood, color, film, aesthetic)
  export const STYLE_KEYWORDS = { /* 150 keywords total */ };
  
  export function extractStyleKeywords(vision: string, maxTerms: number = 5): ExtractedStyle[]
  export function formatStylesForPrompt(styles: ExtractedStyle[], useWeighting: boolean): string
  ```
- **Integration**: Call from `buildSceneKeyframePromptV2` before style segment assembly
- **Testing**: Test file `services/__tests__/styleExtractor.test.ts`
  - Unit test: Extract keywords from sample director's visions
  - Unit test: Verify category prioritization (lighting > mood > film > camera > color > aesthetic)
  - Unit test: Verify weighting format for ComfyUI

---

### Phase 3: Semantic Deduplication (2-3 days)
**Effort**: Low - mostly algorithm work

#### Task 3.1: Semantic Term Grouping (4-6 hours)
- **File**: `services/promptPipeline.ts` (extend existing deduplication)
- **Current**: `deduplicateNegatives()` only removes exact duplicates
- **New**: Add semantic grouping for redundant terms
- **Implementation**:
  ```typescript
  export const SEMANTIC_NEGATIVE_GROUPS = {
    quality_low: ['worst quality', 'low quality', 'bad quality', 'poor quality', 'normal quality', 'lowres'],
    blur: ['blurry', 'blur', 'out of focus', 'unfocused', 'motion blur', 'soft focus'],
    anatomy_hands: ['bad hands', 'poorly drawn hands', 'malformed hands', 'mutated hands', ...],
    anatomy_face: ['poorly drawn face', 'bad face', 'deformed face', 'ugly face', 'distorted face'],
    anatomy_body: ['bad anatomy', 'deformed', 'disfigured', 'malformed', 'mutated', 'mutation', 'bad proportions'],
    duplication: ['duplicate', 'clone', 'cloned face', 'cloned body', 'duplicate subject'],
    framing: ['out of frame', 'cropped', 'cut off', 'partial'],
    artifacts: ['jpeg artifacts', 'compression artifacts', 'pixelated', 'noise', 'grain', 'banding'],
  };
  
  export function semanticDeduplicateNegatives(negatives: string[]): string[]
    // Keeps first occurrence from each semantic group, removes redundant synonyms
  ```
- **Integration**: Use in `assemblePromptForProvider()` alongside exact deduplication
- **Testing**: 
  - Unit test: "low quality" + "worst quality" ‚Üí only first kept
  - Unit test: "bad hands" + "poorly drawn hands" ‚Üí only first kept
  - Measure token savings: expect 10-15% reduction

---

### Phase 4: Character Consistency (3-4 days)
**Effort**: Moderate - new service, moderate complexity

#### Task 4.1: Character Appearance Tracking (8-10 hours)
- **New File**: `services/characterTracker.ts`
- **Purpose**: Track character appearances across timeline, warn on absences
- **Implementation**:
  ```typescript
  export interface CharacterAppearance {
    characterId: string;
    characterName: string;
    shotId: string;
    shotIndex: number;
    isExplicitlyMentioned: boolean;
    visualDescriptor?: string;
  }
  
  export interface CharacterContinuityWarning {
    characterId: string;
    warningType: 'gap' | 'sudden_appearance' | 'inconsistent_descriptor';
    details: string;
    affectedShotIds: string[];
    suggestion: string;
  }
  
  export const MAX_PROTAGONIST_GAP = 3;  // Consecutive shots without appearance
  export const MAX_SUPPORTING_GAP = 5;
  
  export function trackCharacterAppearances(timeline: Timeline, storyBible: StoryBible): Map<string, CharacterAppearance[]>
  export function analyzeCharacterContinuity(appearances: Map<...>, storyBible: StoryBible, totalShots: number): CharacterContinuityWarning[]
  ```
- **Testing**: New file `services/__tests__/characterTracker.test.ts`
  - Unit test: Track appearances correctly
  - Unit test: Detect protagonist gaps correctly
  - Unit test: No warnings when consistent

---

### Phase 5: User Feedback Loop (3-4 days)
**Effort**: Low-Moderate - mostly UI + existing infrastructure

#### Task 5.1: Post-Generation Rating UI (6-8 hours)
- **New Component**: `components/GenerationFeedback.tsx`
- **Purpose**: Collect 1-5 star ratings + regeneration tracking
- **Implementation**:
  - Star rating buttons (1-5)
  - "Regenerate" button (tracks implicit negative feedback)
  - Optional "Show Details" section
  - Integration with `usePromptMetrics` hook (already has `recordQualityScore()`)
- **Testing**: Component test file `components/__tests__/GenerationFeedback.test.tsx`
  - Test rendering
  - Test rating submission
  - Test regeneration tracking

#### Task 5.2: Bayesian A/B Testing (2-3 hours)
- **File**: `services/generationMetrics.ts` (extend existing functions)
- **Add new functions**:
  ```typescript
  export function bayesianProbabilityBetter(
    controlSuccesses: number,
    controlTotal: number,
    treatmentSuccesses: number,
    treatmentTotal: number
  ): number  // Returns P(treatment > control) in [0, 1]
  
  export function compareVariantsWithBayesian(
    control: MetricsSummary,
    treatment: MetricsSummary
  ): {
    probabilityBetter: number;
    recommendation: 'control' | 'treatment' | 'inconclusive';
    confidenceLevel: 'low' | 'medium' | 'high';
  }
  ```
- **Why**: Converges faster than frequentist (30 ‚Üí 10 samples minimum)
- **Testing**: Unit tests in existing metrics test file
  - Test probability calculation
  - Test recommendations at various sample sizes

---

### Phase 6: Token Guard Enforcement (1 day)
**Effort**: Minimal - flag change only

> **‚ö†Ô∏è CLARIFICATION**: `promptTokenGuard` default is already `'warn'` (not `'off'`).
> Phase 6 is a single-step jump from `'warn'` ‚Üí `'block'`, not a two-step rollout.

#### Task 6.1: Enable Block Mode (30 min)
- **File**: `utils/featureFlags.ts` (search: `promptTokenGuard` in `DEFAULT_FEATURE_FLAGS`)
- **Change**: `promptTokenGuard: 'warn'` ‚Üí `promptTokenGuard: 'block'`
- **‚ö†Ô∏è IMPORTANT**: Only do this AFTER Phases 1-5 are validated
- **Pre-rollout checklist**:
  - [ ] All Phase 1-5 tests passing
  - [ ] Analyzed truncation warnings from production use
  - [ ] No critical content patterns in truncation data
  - [ ] User acceptance testing complete

---

## Implementation Sequence (Recommended Order)

```
Week 1 (Days 1-3): Phase 1 Foundation
‚îú‚îÄ Day 1: Task 1.1 (enable flag) + Task 1.3 (enable flag) = 1 hour
‚îú‚îÄ Day 1-2: Task 1.2 (expand negatives) + tests = 3 hours
‚îî‚îÄ Verify: npm test passes, no regressions

Week 1-2 (Days 4-7): Phase 2 CLIP Optimization
‚îú‚îÄ Day 4: Task 2.1 (CLIP chunk awareness) = 6-8 hours
‚îú‚îÄ Day 5-6: Task 2.2 (style extractor service) = 4-6 hours
‚îî‚îÄ Verify: Manual testing with 10 keyframes

Week 2 (Days 8-10): Phase 3 Deduplication
‚îú‚îÄ Day 8-9: Task 3.1 (semantic grouping) = 4-6 hours
‚îî‚îÄ Verify: Token savings measured (expect 10-15%)

Week 2 (Days 11-13): Phase 4 Character Tracking
‚îú‚îÄ Day 11-12: Task 4.1 (character tracker) = 8-10 hours
‚îî‚îÄ Verify: Unit tests passing

Week 3 (Days 14-16): Phase 5 Feedback Loop
‚îú‚îÄ Day 14: Task 5.1 (feedback UI) = 6-8 hours
‚îú‚îÄ Day 15: Task 5.2 (Bayesian) = 2-3 hours
‚îî‚îÄ Verify: E2E test with rating collection

Week 3 (Day 17): Phase 6 Enforcement
‚îú‚îÄ Day 17: Task 6.1 (enable block mode) = 30 min
‚îî‚îÄ Verify: No truncation errors
```

---

## Testing Strategy

### Per-Phase Testing (Incremental)
- **Phase 1**: Add tests to existing `services/__tests__/promptPipeline.test.ts`
- **Phase 2**: New test files for `styleExtractor.test.ts`
- **Phase 3**: Extend `promptPipeline.test.ts`
- **Phase 4**: New test file `characterTracker.test.ts`
- **Phase 5**: New test files for component and metrics
- **Phase 6**: Only configuration change, no new tests needed

### Test Coverage Targets
- Unit tests: ‚úÖ All new functions tested
- Integration tests: ‚úÖ Full pipeline tests
- E2E tests: ‚ö†Ô∏è Manual validation recommended (real generation quality assessment)

### Command Reference
```powershell
# Run all tests
npm test

# Run specific service tests
npm test -- promptPipeline
npm test -- styleExtractor
npm test -- characterTracker
npm test -- generationMetrics

# Run E2E tests
npx playwright test

# Run health checks
npm run check:health-helper
```

---

## Critical Constraints & Patterns

### 1. Feature Flags (Already Established)
- All new behavior must be **flag-gated** for safety
- Add new flags to `utils/featureFlags.ts` following existing pattern
- Default flags to `false` for backward compatibility
- Update `FEATURE_FLAG_META` with descriptions

### 2. Service Layer Pattern (Non-negotiable)
**Never call external APIs directly from components.**
- All Gemini/ComfyUI calls route through service layer
- Services use `withRetry` for resilience
- Example: `services/tokenValidator.ts`, `services/geminiService.ts`

### 3. Prompt Pipeline Architecture
- `buildSceneKeyframePrompt()` - main entry point (routes to V1 or V2)
- `buildSceneKeyframePromptV2()` - subject-first version
- `assemblePromptForProvider()` - format for Gemini/ComfyUI
- All new prompt logic integrates here

### 4. Provider-Specific Logic
- **Gemini**: No weighting support, natural language format
- **ComfyUI**: Weighting syntax `(term:1.2)`, comma-separated
- Check `PROVIDER_CONFIGS` in `services/promptConstants.ts` before implementing

### 5. Token Budgets (Hardcoded Reference)
```typescript
// From services/promptRegistry.ts
DEFAULT_TOKEN_BUDGETS = {
  sceneKeyframe: 600,      // Main budget for this project
  comfyuiShot: 500,
  plotScene: 200,
  // ...
};

// CLIP-specific
CLIP_MAX_TOKENS_PER_CHUNK = 77;  // Hard limit per chunk
```

### 6. Type Safety
- Use existing types from `types/index.ts`
- For new types, add to `types/storyBibleV2.ts` or appropriate file
- Maintain TypeScript `strict` mode (no `any`)

### 7. Testing Patterns (Follow Existing)
```typescript
// From promptPipeline.test.ts (200+ lines of patterns to reuse)
describe('Prompt Feature', () => {
  it('should do X', () => {
    const fixture = createMockStoryBibleV2();
    const result = functionUnderTest(fixture);
    expect(result).toBeDefined();
  });
});
```

---

## Rollout Risk Mitigation

### Safe Defaults
- ‚úÖ `subjectFirstPrompts: true` - Code already tested
- ‚úÖ `promptQualityGate: true` - Non-blocking, informational only
- ‚úÖ `promptTokenGuard: 'warn'` - Logs warnings, doesn't break
- ‚ö†Ô∏è `promptTokenGuard: 'block'` - Only enable AFTER validation

### Validation Checklist Before Each Phase Rollout
- [ ] All unit tests passing (`npm test -- --run`)
- [ ] All E2E tests passing (`npx playwright test`)
- [ ] No console errors or warnings
- [ ] Manual testing: 10 generations per phase
- [ ] No regressions in existing functionality

### Monitoring & Rollback
- If regressions detected: Disable flag and investigate
- Track metrics via `usePromptMetrics` hook for data-driven decisions
- Generate metrics comparison reports after 100 samples per variant

---

## File Map (Quick Reference)

### Configuration & Constants
- `utils/featureFlags.ts` - Feature flag definitions
- `services/promptConstants.ts` - Negative prompts, quality configs
- `services/promptWeighting.ts` - Weighting syntax helpers

### Prompt Assembly (Existing)
- `services/promptPipeline.ts` - Main prompt builders (includes V2 already)
- `services/payloadService.ts` - Timeline ‚Üí prompt transforms

### New Services to Create
- `services/styleExtractor.ts` - Style keyword extraction (Phase 2)
- `services/characterTracker.ts` - Character continuity tracking (Phase 4)

### Token Management
- `services/tokenValidator.ts` - Token counting, CLIP chunks
- `utils/pipelineContext.ts` - Token guard validation

### Metrics & Feedback
- `utils/usePromptMetrics.ts` - Metrics collection hook (already complete)
- `services/generationMetrics.ts` - A/B testing stats (extend for Bayesian)
- `components/GenerationFeedback.tsx` - Rating UI (new component)

### Tests
- `services/__tests__/promptPipeline.test.ts` - Extend for new functions
- `services/__tests__/styleExtractor.test.ts` - New file
- `services/__tests__/characterTracker.test.ts` - New file
- `components/__tests__/GenerationFeedback.test.tsx` - New file

---

## Expected Outcomes

### By End of Week 1
- ‚úÖ Phase 1 complete (3 quick wins)
- ‚úÖ All existing tests passing
- ‚úÖ Subject-first ordering active (flag enabled)
- ‚úÖ 5 new negative categories integrated

### By End of Week 2
- ‚úÖ Phases 1-3 complete
- ‚úÖ Style extraction working
- ‚úÖ Semantic deduplication active
- ‚úÖ Token savings measured (10-15% reduction)

### By End of Week 3
- ‚úÖ All 6 phases complete
- ‚úÖ Feedback UI collecting ratings
- ‚úÖ Character tracking warnings working
- ‚úÖ Ready for production rollout

### Success Metrics
- üéØ 20-30% reduction in regeneration rates
- üéØ 15-25% improvement in anatomical accuracy
- üéØ 10-15% token savings from deduplication
- üéØ Faster A/B convergence (30 ‚Üí 10 samples minimum)

---

## Questions Clarification

### "Should I create styleKeywords.json?"
**Answer**: Not immediately. Create default keywords in `services/styleExtractor.ts`. Later, add optional import feature via Settings UI (same pattern as `localGenSettings.json`).

### "How do I test Phase 2 CLIP optimization?"
**Answer**: 
1. Generate 5 keyframes with `buildSceneKeyframePromptV2`
2. Verify subject appears in first 77 tokens: `estimateTokens(prompt.slice(0, subject.length)) < 77`
3. Compare visual coherence manually vs legacy version

### "When should I enable block mode?"
**Answer**: Only after Phases 1-5 are stable and production-validated. Add to Phase 6 documentation as final step.

### "Do I need to update existing tests?"
**Answer**: Only add new assertions to existing tests in Phase 1 (e.g., subject-first tests already exist, just verify the flag works). For new functionality, create new test files.

---

## Contact & Escalation

### Success Criteria
- ‚úÖ All tests passing (`npm test && npx playwright test`)
- ‚úÖ No build errors
- ‚úÖ All 13 tasks completed with acceptance criteria met
- ‚úÖ Metrics show improvement (regeneration rate down 20-30%)

### If Stuck
1. Check the implementation guide: `PROMPT_OPTIMIZATION_IMPLEMENTATION_GUIDE.md`
2. Review test patterns in `promptPipeline.test.ts`
3. Check existing service examples (`geminiService.ts`, `tokenValidator.ts`)
4. Verify flags are properly defined in `featureFlags.ts`

---

## Next Steps (First 30 Minutes)

1. **Read** `PROMPT_OPTIMIZATION_IMPLEMENTATION_GUIDE.md` (10 min)
2. **Review** existing `promptPipeline.ts` to understand structure (10 min)
3. **Run** `npm test` to ensure baseline passes (5 min)
4. **Start** Phase 1 Task 1.1: Change flag default in `featureFlags.ts`

---

**This handoff is complete and ready for implementation.**
**Estimated completion: 2-3 weeks**
**Expected impact: 20-30% reduction in regeneration rates**
